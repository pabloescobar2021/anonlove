{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/%D0%95%D0%BB%D0%B5%D0%BD%D0%B0/Desktop/next.js/my-next-app/app/api/lots/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\n\r\ntype Lot = {\r\n    id: string;\r\n    label: string;\r\n    weight: number;\r\n    color?: string;\r\n    enabled?: boolean;\r\n}\r\n\r\nlet lots: Lot[] = []\r\n\r\nconst clients = new Set<ReadableStreamDefaultController>()\r\n\r\nexport async function GET(req: NextRequest) {\r\n    const encoder = new TextEncoder()\r\n\r\n    const stream = new ReadableStream({\r\n        start(controller) {\r\n            clients.add(controller)\r\n            console.log('✅ Клиент подключился. Всего:', clients.size);\r\n\r\n            const initialMessage = `data: ${JSON.stringify({\r\n                type: 'INITIAL_LOTS',\r\n                data: lots\r\n            })}\\n\\n`\r\n\r\n            controller.enqueue(encoder.encode(initialMessage))\r\n\r\n            const keepAlive = setInterval(() => {\r\n                try {\r\n                    controller.enqueue(encoder.encode(': keep-alive\\n\\n'))\r\n                } catch {\r\n                    clearInterval(keepAlive)\r\n                }\r\n            }, 30000)\r\n\r\n            req.signal.addEventListener('abort', () => {\r\n                clearInterval(keepAlive)\r\n                clients.delete(controller)\r\n                console.log('❌ Клиент отключился. Всего:', clients.size);\r\n            })\r\n        }\r\n    });\r\n\r\n    return new Response(stream, {\r\n        headers: {\r\n            'Content-Type': 'text/event-stream',\r\n            'Cache-Contol': 'no-cache, no-transform',\r\n            'Connection': 'keep-alive',\r\n        }\r\n    })\r\n}\r\n\r\nexport function broadcastToClients(message:any){\r\n    const encoder = new TextEncoder()\r\n    const data = `data: ${JSON.stringify(message)}\\n\\n`\r\n\r\n    clients.forEach(controller => {\r\n        try {\r\n            controller.enqueue(encoder.encode(data))\r\n        } catch(error) {\r\n            console.error('Error broadcasting message to client:', error);\r\n            clients.delete(controller)\r\n        }\r\n    })\r\n}\r\n\r\nexport {lots, clients}"],"names":[],"mappings":";;;;;;;;;;AAUA,IAAI,OAAc,EAAE;AAEpB,MAAM,UAAU,IAAI;AAEb,eAAe,IAAI,GAAgB;IACtC,MAAM,UAAU,IAAI;IAEpB,MAAM,SAAS,IAAI,eAAe;QAC9B,OAAM,UAAU;YACZ,QAAQ,GAAG,CAAC;YACZ,QAAQ,GAAG,CAAC,gCAAgC,QAAQ,IAAI;YAExD,MAAM,iBAAiB,CAAC,MAAM,EAAE,KAAK,SAAS,CAAC;gBAC3C,MAAM;gBACN,MAAM;YACV,GAAG,IAAI,CAAC;YAER,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;YAElC,MAAM,YAAY,YAAY;gBAC1B,IAAI;oBACA,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;gBACtC,EAAE,OAAM;oBACJ,cAAc;gBAClB;YACJ,GAAG;YAEH,IAAI,MAAM,CAAC,gBAAgB,CAAC,SAAS;gBACjC,cAAc;gBACd,QAAQ,MAAM,CAAC;gBACf,QAAQ,GAAG,CAAC,+BAA+B,QAAQ,IAAI;YAC3D;QACJ;IACJ;IAEA,OAAO,IAAI,SAAS,QAAQ;QACxB,SAAS;YACL,gBAAgB;YAChB,gBAAgB;YAChB,cAAc;QAClB;IACJ;AACJ;AAEO,SAAS,mBAAmB,OAAW;IAC1C,MAAM,UAAU,IAAI;IACpB,MAAM,OAAO,CAAC,MAAM,EAAE,KAAK,SAAS,CAAC,SAAS,IAAI,CAAC;IAEnD,QAAQ,OAAO,CAAC,CAAA;QACZ,IAAI;YACA,WAAW,OAAO,CAAC,QAAQ,MAAM,CAAC;QACtC,EAAE,OAAM,OAAO;YACX,QAAQ,KAAK,CAAC,yCAAyC;YACvD,QAAQ,MAAM,CAAC;QACnB;IACJ;AACJ"}}]
}