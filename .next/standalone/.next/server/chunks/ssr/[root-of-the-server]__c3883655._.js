module.exports=[72131,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].React},9270,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored.contexts.AppRouterContext},36313,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored.contexts.HooksClientContext},18341,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored.contexts.ServerInsertedHtml},18622,(a,b,c)=>{b.exports=a.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},20635,(a,b,c)=>{b.exports=a.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},42602,(a,b,c)=>{"use strict";b.exports=a.r(18622)},87924,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].ReactJsxRuntime},14139,a=>{"use strict";var b=a.i(72131),c=a.i(10845);async function d(a){let{data:b,error:d}=await c.supabase.from("messages_safe").select(`
            *
            `).eq("to_user",a).order("created_at",{ascending:!0});if(d)throw d;return(b||[]).map(a=>{let b=a.user_anonymous_settings?.[0]?.is_anon;return{...a,displayId:b||a.is_anon?"Anon":a.from_public_id,username:b||a.is_anon?"Anon":a.from_username}})}async function e(a,b){let{data:d,error:e}=await c.supabase.from("messages_safe").select("*").eq("id",a).eq("to_user",b).single();if(e)throw e;return d||[]}async function f(a){let{data:b,error:d}=await c.supabase.from("messages_safe").select(`
            *`).eq("from_user",a).order("created_at",{ascending:!0});if(d)throw d;return b||[]}async function g({fromUserId:a,toUserId:b,toPublicId:d,body:e,isAnon:f}){let g=b;if(!g){if(!d)throw Error("Не указан пользователь, малыш");let{data:a,error:b}=await c.supabase.from("users").select("id_user").eq("public_id",d).single();if(b||!a)throw Error("Пользователь не найден, кись");g=a.id_user}let{error:h}=await c.supabase.from("user_anonymous_settings").upsert([{from_user_id:a,to_user_id:g,is_anon:f}],{onConflict:"from_user_id,to_user_id"});if(h)throw h;let{error:i}=await c.supabase.from("messages").insert({from_user:a,to_user:g,body:e});if(i)throw i}function h(a){let[c,e]=(0,b.useState)([]),[h,i]=(0,b.useState)([]),[j,k]=(0,b.useState)(!0),l=async()=>{if(a)try{k(!0);let[b,c]=await Promise.all([d(a),f(a)]);e(b),i(c)}catch(a){console.error("Error loading messages:",a)}finally{k(!1)}};return(0,b.useEffect)(()=>{l()},[a]),{inbox:c,sent:h,loading:j,sendMessage:async(b,c,d)=>{if(!a)throw Error("User not logged in");await g({fromUserId:a,toUserId:b.userId,toPublicId:b.publicId,body:c,isAnon:d}),await l()},refresh:l}}function i(a,c){let[d,f]=(0,b.useState)(null),[g,h]=(0,b.useState)(!1);return(0,b.useEffect)(()=>{a&&c&&(async()=>{h(!0);try{let b=await e(c,a);f(b)}catch(a){console.error("Error loading messages:",a)}finally{h(!1)}})()},[a,c]),{message:d,loading:g}}function j(a,c,d){return(0,b.useMemo)(()=>{let b=new Map;for(let e of[...a,...c]){let a=e.from_user===d?e.to_user:e.from_user,c="";if(c="A"===e.from_display_id?"Anon":e.from_display_id,b.has(a)){let c=b.get(a);c.messages.push(e),c.count++,new Date(e.created_at)>new Date(c.lastMessage.created_at)&&(c.lastMessage=e)}else b.set(a,{userId:a,displayId:c,lastMessage:e,messages:[e],count:1})}return Array.from(b.values()).sort((a,b)=>new Date(b.lastMessage.created_at).getTime()-new Date(a.lastMessage.created_at).getTime())},[a,c,d])}a.s(["useCurrentMessage",()=>i,"useDialogs",()=>j,"useMessages",()=>h],14139)},84121,58056,a=>{"use strict";var b=a.i(72131),c=a.i(10845);async function d(){let{data:a,error:b}=await c.supabase.auth.getUser();if(!b)return a.user}async function e(a){let{data:b,error:d}=await c.supabase.from("users").select("public_id, username").eq("id_user",a).single();return d?null:b}async function f(){let{error:a}=await c.supabase.auth.signOut();if(a)throw a}function g(a){let{data:b}=c.supabase.auth.onAuthStateChange((b,c)=>{a(c?.user||null)});return b.subscription}function h(){let[a,c]=(0,b.useState)(null),[f,h]=(0,b.useState)(null),[i,j]=(0,b.useState)(!0);return(0,b.useEffect)(()=>{(async()=>{try{let a=await d();if(c(a),a){let b=await e(a.id);h(b)}}catch(a){console.error("Error loading user:",a)}finally{j(!1)}})();let a=g(async a=>{c(a),a?h(await e(a.id)):h(null)});return()=>{a.unsubscribe()}},[]),{user:a,profile:f,loading:i}}a.s(["getCurrentUser",()=>d,"getUserProfile",()=>e,"onAuthStateChange",()=>g,"sighOut",()=>f],58056),a.s(["useAuth",()=>h],84121)},97562,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944);let e=(a,b,c)=>a+(b-a)*c,f=()=>({r:Math.floor(256*Math.random()),g:0,b:0,a:.1});var g=a.i(14139),h=a.i(84121);function i({initialData:a}){let i,j,k,l,m,n,o=(0,d.useSearchParams)().get("to"),p=o?decodeURIComponent(o):null,[q,r]=(0,c.useState)(null),[s,t]=(0,c.useState)(!1),{user:u,profile:v,loading:w}=(0,h.useAuth)(),{inbox:x,sent:y,sendMessage:z,loading:A}=(0,g.useMessages)(u?.id||null),B=(0,d.useRouter)(),[C,D]=(0,c.useState)(a?.items||[]),E=(0,c.useRef)(null),[F,G]=(0,c.useState)(!1),H=(0,c.useRef)(null),I=(0,c.useRef)(null),[J,K]=(0,c.useState)(!1),[L,M]=(0,c.useState)(!1),{startDrag:N,startResize:O,deleteItem:P}=(i=(0,c.useRef)({id:null,offsetX:0,offsetY:0,w:0,h:0}),j=(0,c.useRef)({id:null,startX:0,startY:0,startW:0,startH:0,fontSize:0,direction:"horizontal"}),k=a=>{if(null!==j.current.id)return;let b=E.current.getBoundingClientRect(),c=i.current;if(null===c.id)return;let d=a.clientX-b.left-c.offsetX,e=a.clientY-b.top-c.offsetY;d=Math.max(-c.w/2,Math.min(d,b.width-c.w/2)),e=Math.max(-c.h/2,Math.min(e,b.height-c.h/2)),D(a=>a.map(a=>a.id===c.id?{...a,x:d,y:e}:a))},l=()=>{i.current.id=null,window.removeEventListener("mousemove",k),window.removeEventListener("mouseup",l)},m=a=>{let b=j.current;if(null===b.id)return;let c=a.clientX-b.startX,d=a.clientY-b.startY,e=b.startW,f=b.startH,g=b.fontSize;"horizontal"===b.direction&&(e=Math.max(50,b.startW+c)),"top"===b.direction&&(f=Math.max(30,b.startH+d)),"bottom"===b.direction&&(f=Math.max(30,b.startH+d)),"diagonal"===b.direction&&(e=Math.max(50,b.startW+c),f=Math.max(30,b.startH+d),g=Math.max(2,b.fontSize+(c+d)/5)),console.log("resize direction:",b.direction,"w:",e,"h:",f,"fontSize:",g),D(a=>a.map(a=>a.id===b.id?{...a,w:e,h:f,fontSize:g}:a))},n=()=>{j.current.id=null,window.removeEventListener("mousemove",m),window.removeEventListener("mouseup",n)},{startDrag:(a,b)=>{let c=E.current.getBoundingClientRect();i.current={id:b.id,offsetX:a.clientX-c.left-b.x,offsetY:a.clientY-c.top-b.y,w:b.w,h:b.h},window.addEventListener("mousemove",k),window.addEventListener("mouseup",l)},startResize:(a,b,c)=>{a.stopPropagation(),j.current={id:b.id,startX:a.clientX,startY:a.clientY,startW:b.w,startH:b.h,fontSize:b.fontSize,direction:c},window.addEventListener("mousemove",m),window.addEventListener("mouseup",n)},deleteItem:a=>{D(b=>b.filter(b=>b.id!==a.id))}});(0,c.useEffect)(()=>{p&&(r(p),t(!0))},[p]);let{bg:Q}=function(){let[a,b]=(0,c.useState)({r:0,g:0,b:0,a:.1}),d=(0,c.useRef)(a),g=(0,c.useRef)(null);return(0,c.useEffect)(()=>{let a=null,c=d.current,h=f(),i=j=>{var k,l;let m;a||(a=j);let n=Math.min((j-a)/3e3,1),o=(k=c,l=h,m=n*n*(3-2*n),{r:e(k.r,l.r,m),g:e(k.g,l.g,m),b:e(k.b,l.b,m),a:e(k.a,l.a,m)});d.current=o,b(o),n<1||(c=h,h=f(),a=null),g.current=requestAnimationFrame(i)};return g.current=requestAnimationFrame(i),()=>{g.current&&cancelAnimationFrame(g.current)}},[]),{bg:a}}(),R=`rgba(${Math.floor(Q.r)}, ${Math.floor(Q.g)}, ${Math.floor(Q.b)}, ${Q.a})`,S=async()=>{let a=H.current?.value||"";if(I.current?.checked,!a)return void alert("Введи ID, сладкий!");let b=C.map(({isSelected:a,isEditing:b,...c})=>c);console.log("SEND PAYLOAD",b);try{await z({publicId:a},b,J),H.current.value="",G(!1)}catch(a){console.log(a.message||"Error sending message")}};return(0,b.jsxs)("div",{className:"relative flex flex-col justify-center items-center h-full",style:{backgroundColor:R},children:[(0,b.jsx)("div",{className:"relative border w-1/2 h-1/2 rounded-md bg-white overflow-hidden z-10 ",ref:E,onMouseDown:a=>{a.target===a.currentTarget&&D(a=>a.map(a=>({...a,isSelected:!1,isEditing:"none"})))},children:C.map((a,c)=>(0,b.jsx)("div",{className:`flex 
                                text-black select-none relative 
                                ${a.isSelected&&"text"!==a.isEditing?"border":""}
                                `,style:{position:"absolute",left:a.x,top:a.y,width:a.w,height:a.h,fontSize:a.fontSize,cursor:a.isSelected?"move":"pointer"},onDoubleClick:()=>{D(b=>b.map(b=>b.id===a.id?{...b,isEditing:"text"}:b))},onMouseDown:b=>{N(b,a),D(b=>b.map(b=>({...b,isSelected:b.id===a.id})))},children:"text"===a.isEditing?(0,b.jsx)("input",{autoFocus:!0,value:a.content,onChange:b=>{D(c=>c.map(c=>c.id===a.id?{...c,content:b.target.value}:c))},onBlur:()=>{D(b=>b.map(b=>b.id===a.id?{...b,isEditing:"none"}:b))},onKeyDown:a=>{"Enter"===a.key&&a.currentTarget.blur()}}):(0,b.jsxs)("div",{className:`relative w-full h-full text-wrap wrap-break-word flex 
                                            ${a.isSelected?" ":"overflow-hidden"}`,children:[a.content,a.isSelected&&(0,b.jsxs)("div",{className:"",children:[(0,b.jsx)("div",{className:"absolute -top-1.5 -right-2.5 ",children:(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)("svg",{onClick:a=>{L?M(!1):M(!0),a.stopPropagation()},className:"hover:scale-110 transition-transform cursor-pointer",xmlns:"http://www.w3.org/2000/svg",width:"10",height:"10",viewBox:"0 0 32 32",children:(0,b.jsx)("path",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 8h24M4 16h24M4 24h24"})}),(0,b.jsx)("div",{className:`absolute top-1 left-full text-[9px] bg-black/20 rounded-md w-15 h-15 flex flex-col
                                                        ${L?"opacity-100":"opacity-0"} transition-opacity`,children:(0,b.jsx)("button",{className:"hover:bg-black/10 transition-colors",onClick:()=>{P(a)},children:"Удалить"})})]})}),(0,b.jsx)("div",{onMouseDown:b=>{b.stopPropagation(),O(b,a,"horizontal")},className:"absolute -right-1 bottom-1/2 translate-y-1/2 w-1 h-3 bg-white    border cursor-w-resize"}),(0,b.jsx)("div",{onMouseDown:b=>{b.stopPropagation(),O(b,a,"top")},className:"absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-1 bg-white    border cursor-s-resize"}),(0,b.jsx)("div",{onMouseDown:b=>{b.stopPropagation(),O(b,a,"bottom")},className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-1 bg-white    border cursor-s-resize"}),(0,b.jsx)("div",{onMouseDown:b=>{b.stopPropagation(),O(b,a,"diagonal")},className:"absolute -bottom-1.5 -right-1.5  w-2 h-2 bg-white    border cursor-se-resize"})]})]})},a.id))}),(0,b.jsx)("div",{className:"flex p-2 mt-10",children:(0,b.jsx)("button",{className:"p-2 border rounded-2xl",onClick:()=>{D(a=>[...a,{id:a.length,type:"text",content:`new text ${a.length+1}`,x:0,y:0+20*a.length,w:100,h:50,fontSize:16,scaleX:1,scaleY:1,rotation:0,isEditing:"none"}])},children:"Text"})}),(0,b.jsx)("div",{className:"absolute left-0 inset-y-0 flex justify-center items-center    w-7 rounded-r-full bg-white/10 hover:bg-white/20 transition-cursor",children:(0,b.jsx)("button",{onClick:()=>B.push("anonlovemain"),className:"w-full h-full",children:"<"})}),(0,b.jsxs)("div",{className:"absolute right-0 inset-y-0 flex justify-center items-center   w-7 rounded-l-full bg-white/10 hover:bg-white/20 transition-cursor",children:[(0,b.jsx)("button",{onClick:()=>{G(!0)},className:"w-full h-full",children:"..."}),(0,b.jsx)("div",{className:`fixed inset-0 z-30 bg-black/50 transition-all duration-300
                                ${F?"backdrop-blur-lg translate-x-0":"backdrop-blur-none translate-x-full"}
                            `,onMouseDown:a=>G(!1),children:(0,b.jsx)("div",{className:"absolute right-0 inset-y-0 flex justify-center items-center w-[400px] bg-black/90 z-20",onMouseDown:a=>{a.stopPropagation()},children:(0,b.jsxs)("form",{className:"relative flex flex-col w-full justify-center items-center",onSubmit:a=>{a.preventDefault()},children:[(0,b.jsx)("input",{ref:H,value:q||"",onChange:a=>r(a.target.value),disabled:s,type:"text",placeholder:"ID кисы",className:`p-2 mb-4 w-1/2 bg-white/10 border rounded-md text-white
                                            ${s&&"opacity-50"}
                                    `}),(0,b.jsxs)("div",{className:"flex w-full justify-center items-center",children:[(0,b.jsx)("input",{type:"checkbox",ref:I,checked:J,onChange:a=>{},className:"bg-white/10 border rounded-md text-white"}),(0,b.jsx)("span",{className:"text-[10px]",children:`Будешь анонимен? (потом можно изменить)`})]}),(0,b.jsx)("button",{type:"submit",className:"p-2 mt-4 border rounded-2xl hover:bg-white/20 transition-all duration-200",onClick:S,children:"Отправить"}),(0,b.jsx)("button",{className:"absolute left-0 w-10 h-20 bg-white/20 rounded-r-full top-1/2 -translate-y-1/2   hover:bg-white/40 transition-all duration-200   ",onClick:()=>G(!1),children:">"})]})})})]})]})}a.s(["default",()=>i],97562)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__c3883655._.js.map