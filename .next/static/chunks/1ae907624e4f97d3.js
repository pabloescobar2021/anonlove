(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,82853,19184,79262,e=>{"use strict";var t=e.i(71645),s=e.i(14179);async function r(){let{data:e,error:t}=await s.supabase.auth.getUser();if(!t)return e.user}async function n(e){let{data:t,error:r}=await s.supabase.from("users").select("public_id, username").eq("id_user",e).single();return r?null:t}async function o(){let{error:e}=await s.supabase.auth.signOut();if(e)throw e}function i(e){let{data:t}=s.supabase.auth.onAuthStateChange((t,s)=>{e(s?.user||null)});return t.subscription}function a(){let[e,s]=(0,t.useState)(null),[o,a]=(0,t.useState)(null),[l,u]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{(async()=>{try{let e=await r();if(s(e),e){let t=await n(e.id);a(t)}}catch(e){console.error("Error loading user:",e)}finally{u(!1)}})();let e=i(async e=>{s(e),e?a(await n(e.id)):a(null)});return()=>{e.unsubscribe()}},[]),{user:e,profile:o,loading:l}}async function l(e){let{data:t,error:r}=await s.supabase.from("messages_safe").select(`
            *
            `).eq("to_user",e).order("created_at",{ascending:!0});if(r)throw r;return(t||[]).map(e=>{let t=e.user_anonymous_settings?.[0]?.is_anon;return{...e,displayId:t||e.is_anon?"Anon":e.from_public_id,username:t||e.is_anon?"Anon":e.from_username}})}async function u(e,t,r){console.log("Querying message:",{messageId:e,userId:t});let{data:n,error:o}=await s.supabase.from("messages_safe").select("*").eq("id",e).eq("true"===r?"from_user":"to_user",t).maybeSingle();if(console.log("Query result:",{data:n,error:o}),o)throw o;return n||[]}async function c(e){let{data:t,error:r}=await s.supabase.from("messages_safe").select(`
            *`).eq("from_user",e).order("created_at",{ascending:!0});if(r)throw r;return t||[]}async function d({fromUserId:e,toUserId:t,toPublicId:r,body:n,isAnon:o}){let i=t;if(!i){if(!r)throw Error("Не указан пользователь, малыш");let{data:e,error:t}=await s.supabase.from("users").select("id_user").eq("public_id",r).single();if(t||!e)throw Error("Пользователь не найден, кись");i=e.id_user}let{error:a}=await s.supabase.from("user_anonymous_settings").upsert([{from_user_id:e,to_user_id:i,is_anon:o}],{onConflict:"from_user_id,to_user_id"});if(a)throw a;let{error:l}=await s.supabase.from("messages").insert({from_user:e,to_user:i,body:n});if(l)throw l}function h(e){return{...e,isEditing:"none",isSelected:!1}}function f(e){let[s,r]=(0,t.useState)([]),[n,o]=(0,t.useState)([]),[i,a]=(0,t.useState)(!0),u=async()=>{if(e)try{a(!0);let[t,s]=await Promise.all([l(e),c(e)]);r(t),o(s)}catch(e){console.error("Error loading messages:",e)}finally{a(!1)}};return(0,t.useEffect)(()=>{u()},[e]),{inbox:s,sent:n,loading:i,sendMessage:async(t,s,r)=>{if(!e)throw Error("User not logged in");await d({fromUserId:e,toUserId:t.userId,toPublicId:t.publicId,body:s,isAnon:r}),await u()},refresh:u}}function m(e,s,r){let[n,o]=(0,t.useState)(null),[i,a]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{e&&s&&(async()=>{a(!0);try{let t=await u(s,e,r);o({...t,body:t.body.map(h)})}catch(e){console.error("Error loading messages:",e)}finally{a(!1)}})()},[e,s]),{message:n,loading:i}}function w(e,s,r){return(0,t.useMemo)(()=>{let t=new Map;for(let n of[...e,...s]){let e=n.from_user===r?n.to_user:n.from_user,s="";if(s="A"===n.from_display_id?"Anon":n.from_display_id,t.has(e)){let s=t.get(e);s.messages.push(n),s.count++,new Date(n.created_at)>new Date(s.lastMessage.created_at)&&(s.lastMessage=n)}else t.set(e,{userId:e,displayId:s,lastMessage:n,messages:[n],count:1})}return Array.from(t.values()).sort((e,t)=>new Date(t.lastMessage.created_at).getTime()-new Date(e.lastMessage.created_at).getTime())},[e,s,r])}e.s(["getCurrentUser",()=>r,"getUserProfile",()=>n,"onAuthStateChange",()=>i,"sighOut",()=>o],19184),e.s(["useAuth",()=>a],82853),e.s(["useCurrentMessage",()=>m,"useDialogs",()=>w,"useMessages",()=>f],79262)},33005,e=>{"use strict";var t=e.i(71645);function s(e=768){let[r,n]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{let e=()=>{n(window.innerWidth<=768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[e]),r}e.s(["useCheckMobile",()=>s])},1356,e=>{"use strict";var t=e.i(43476),s=e.i(71645),r=e.i(18566);let n=(e,t,s)=>e+(t-e)*s,o=()=>({r:Math.floor(256*Math.random()),g:0,b:0,a:.1});var i=e.i(82853),a=e.i(79262),l=e.i(33005);function u({initialData:e}){let{user:u,profile:c,loading:d}=(0,i.useAuth)(),h=(0,r.useSearchParams)(),f=h.get("id"),m=f?decodeURIComponent(f):null,w=h.get("to"),g=w?decodeURIComponent(w):null,[b,p]=(0,s.useState)(null),[x,v]=(0,s.useState)(!1),y=h.get("isMine"),j=h.get("type"),[S,k]=(0,s.useState)(null),M="recieve"===j,N=(0,l.useCheckMobile)(),{sendMessage:_,loading:E}=(0,a.useMessages)(u?.id||null),{message:C,loading:z}=(0,a.useCurrentMessage)(M&&u?.id||null,M?m:null,y),$=(0,r.useRouter)(),[D,Y]=(0,s.useState)(e?.items||[]),T=(0,s.useRef)(null),[L,X]=(0,s.useState)({scale:1,offsetX:0,offsetY:0}),[P,A]=(0,s.useState)(!1),R=(0,s.useRef)(null),I=(0,s.useRef)(null),[U,q]=(0,s.useState)(!1),[W,O]=(0,s.useState)(!1),B=(0,s.useRef)(null),{startDrag:H,startResize:F,deleteItem:K}=((e,t,r,n)=>{let o=(0,s.useRef)({id:null,offsetX:0,offsetY:0,w:0,h:0}),i=(0,s.useRef)({id:null,startX:0,startY:0,startW:0,startH:0,fontSize:0,direction:"horizontal"});function a(e,t,s,r){return{x:(e-s.left-r.offsetX)/r.scale,y:(t-s.top-r.offsetY)/r.scale}}let l=e=>{let s,l;if(null!==i.current.id)return;let u=r.current.getBoundingClientRect(),c=o.current;if(e instanceof TouchEvent){if(0===e.touches.length)return;s=e.touches[0].clientX,l=e.touches[0].clientY}else s=e.clientX,l=e.clientY;let d=a(s,l,u,n);null!==c.id&&t(e=>e.map(e=>e.id===c.id?{...e,x:d.x-c.offsetX,y:d.y-c.offsetY}:e))},u=()=>{o.current.id=null,window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",u),window.removeEventListener("touchmove",l),window.removeEventListener("touchend",u)},c=e=>{let s,r,o=i.current;if(null===o.id)return;if(e instanceof TouchEvent){if(0===e.touches.length)return;s=e.touches[0].clientX,r=e.touches[0].clientY}else s=e.clientX,r=e.clientY;let a=(s-o.startX)/n.scale,l=(r-o.startY)/n.scale,u=o.startW,c=o.startH,d=o.fontSize;"horizontal"===o.direction&&(u=Math.max(50,o.startW+a)),"top"===o.direction&&(c=Math.max(30,o.startH+l)),"bottom"===o.direction&&(c=Math.max(30,o.startH+l)),"diagonal"===o.direction&&(u=Math.max(50,o.startW+a),c=Math.max(30,o.startH+l),d=Math.max(2,o.fontSize+(a+l)/5)),t(e=>e.map(e=>e.id===o.id?{...e,w:u,h:c,fontSize:d}:e))},d=()=>{i.current.id=null,window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",d),window.removeEventListener("touchmove",c),window.removeEventListener("touchend",d)};return{startDrag:(e,t)=>{let s,i,c=r.current.getBoundingClientRect();if("touches"in e){if(0===e.touches.length)return;s=e.touches[0].clientX,i=e.touches[0].clientY}else s=e.clientX,i=e.clientY;let d=a(s,i,c,n);o.current={id:t.id,offsetX:d.x-t.x,offsetY:d.y-t.y,w:t.w,h:t.h},window.addEventListener("mousemove",l),window.addEventListener("mouseup",u),window.addEventListener("touchmove",l),window.addEventListener("touchend",u)},startResize:(e,t,s)=>{let r,n;if(e.stopPropagation(),"touches"in e){if(0===e.touches.length)return;r=e.touches[0].clientX,n=e.touches[0].clientY}else r=e.clientX,n=e.clientY;i.current={id:t.id,startX:r,startY:n,startW:t.w,startH:t.h,fontSize:t.fontSize,direction:s},window.addEventListener("mousemove",c),window.addEventListener("mouseup",d),window.addEventListener("touchmove",c),window.addEventListener("touchend",d)},deleteItem:e=>{t(t=>t.filter(t=>t.id!==e.id))}}})(0,Y,T,L);(0,s.useEffect)(()=>{g&&(p(g),v(!0)),j&&k({type:j})},[g,j]),(0,s.useEffect)(()=>{M&&C&&(z||Y(C.body))},[M,C]);let{bg:Q}=function(){let[e,t]=(0,s.useState)({r:0,g:0,b:0,a:.1}),r=(0,s.useRef)(e),i=(0,s.useRef)(null);return(0,s.useEffect)(()=>{let e=null,s=r.current,a=o(),l=u=>{var c,d;let h;e||(e=u);let f=Math.min((u-e)/3e3,1),m=(c=s,d=a,h=f*f*(3-2*f),{r:n(c.r,d.r,h),g:n(c.g,d.g,h),b:n(c.b,d.b,h),a:n(c.a,d.a,h)});r.current=m,t(m),f<1||(s=a,a=o(),e=null),i.current=requestAnimationFrame(l)};return i.current=requestAnimationFrame(l),()=>{i.current&&cancelAnimationFrame(i.current)}},[]),{bg:e}}(),G=`rgba(${Math.floor(Q.r)}, ${Math.floor(Q.g)}, ${Math.floor(Q.b)}, ${Q.a})`,J=async()=>{let e=R.current?.value||"";if(I.current?.checked,!e)return void alert("Введи ID, сладкий!");let t=D.map(({isSelected:e,isEditing:t,...s})=>s);console.log("SEND PAYLOAD",t);try{await _({publicId:e},t,U),R.current.value="",A(!1)}catch(e){console.log(e.message||"Error sending message")}},V=e=>{X(t=>({...t,scale:Math.min(3,Math.max(.3,t.scale-.001*e.deltaY))}))},Z=(e,t)=>{let s=e.clientX-t.clientX,r=e.clientY-t.clientY;return Math.sqrt(s*s+r*r)},ee=e=>{2===e.touches.length&&(B.current=Z(e.touches[0],e.touches[1]))},et=e=>{if(2===e.touches.length&&null!==B.current){e.preventDefault();let t=Z(e.touches[0],e.touches[1]),s=t-B.current;X(e=>({...e,scale:Math.min(3,Math.max(.3,e.scale+.01*s))})),B.current=t}},es=()=>{B.current=null};return S?.type==="send"?(0,t.jsxs)("div",{className:"relative flex flex-col justify-center items-center h-full overflow-hidden",style:{backgroundColor:G},children:[(0,t.jsx)("div",{className:`relative border  rounded-md bg-white overflow-hidden z-10
                        ${N?"w-full h-1/2":"w-1/2 h-1/2"}
                        `,ref:T,onMouseDown:e=>{e.target===e.currentTarget&&Y(e=>e.map(e=>({...e,isSelected:!1,isEditing:"none"})))},onWheel:V,onTouchStart:ee,onTouchMove:et,onTouchEnd:es,style:{transform:`
                        translate(${L.offsetX}px, ${L.offsetY}px)
                        scale(${L.scale})
                        `,transformOrigin:"center center"},children:D.map((e,s)=>(0,t.jsx)("div",{className:`flex 
                                    text-black select-none relative 
                                    ${e.isSelected&&"text"!==e.isEditing?"border":""}
                                    `,style:{position:"absolute",left:e.x,top:e.y,width:e.w,height:e.h,fontSize:e.fontSize,cursor:e.isSelected?"move":"pointer"},onDoubleClick:()=>{Y(t=>t.map(t=>t.id===e.id?{...t,isEditing:"text"}:t))},onMouseDown:t=>{H(t,e),Y(t=>t.map(t=>({...t,isSelected:t.id===e.id})))},onTouchStart:t=>{H(t,e),Y(t=>t.map(t=>({...t,isSelected:t.id===e.id})))},children:"text"===e.isEditing?(0,t.jsx)("input",{autoFocus:!0,value:e.content,onChange:t=>{Y(s=>s.map(s=>s.id===e.id?{...s,content:t.target.value}:s))},onBlur:()=>{Y(t=>t.map(t=>t.id===e.id?{...t,isEditing:"none"}:t))},onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur()}}):(0,t.jsxs)("div",{className:`relative w-full h-full text-wrap wrap-break-word flex 
                                                ${e.isSelected?" ":"overflow-hidden"}`,children:[e.content,e.isSelected&&(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("div",{className:"absolute -top-1.5 -right-2.5 ",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("svg",{onClick:e=>{W?O(!1):O(!0),e.stopPropagation()},className:"hover:scale-110 transition-transform cursor-pointer",xmlns:"http://www.w3.org/2000/svg",width:"10",height:"10",viewBox:"0 0 32 32",children:(0,t.jsx)("path",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 8h24M4 16h24M4 24h24"})}),(0,t.jsx)("div",{className:`absolute top-1 left-full text-[9px] bg-black/20 rounded-md w-15 h-15 flex flex-col
                                                            ${W?"opacity-100":"opacity-0"} transition-opacity`,children:(0,t.jsx)("button",{className:"hover:bg-black/10 transition-colors",onClick:()=>{K(e)},children:"Удалить"})})]})}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),F(t,e,"horizontal")},onTouchStart:t=>{t.stopPropagation(),F(t,e,"horizontal")},className:"absolute -right-1 bottom-1/2 translate-y-1/2 w-1 h-3 bg-white    border cursor-w-resize"}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),F(t,e,"top")},onTouchStart:t=>{t.stopPropagation(),F(t,e,"top")},className:"absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-1 bg-white    border cursor-s-resize"}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),F(t,e,"bottom")},onTouchStart:t=>{t.stopPropagation(),F(t,e,"bottom")},className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-1 bg-white    border cursor-s-resize"}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),F(t,e,"diagonal")},onTouchStart:t=>{t.stopPropagation(),F(t,e,"diagonal")},className:"absolute -bottom-1.5 -right-1.5  w-2 h-2 bg-white    border cursor-se-resize"})]})]})},e.id))}),(0,t.jsx)("div",{className:"flex p-2 mt-10",children:(0,t.jsx)("button",{className:"p-2 border rounded-2xl",onClick:()=>{Y(e=>[...e,{id:e.length,type:"text",content:`new text ${e.length+1}`,x:0,y:0+20*e.length,w:100,h:50,fontSize:16,scaleX:1,scaleY:1,rotation:0,isEditing:"none"}])},children:"Text"})}),(0,t.jsx)("div",{className:`absolute left-0  flex justify-center items-center 
                    w-7 rounded-r-full backdrop-blur-md hover:bg-white/20 transition-cursor
                    md:inset-y-0
                    inset-y-60
                    z-20
                    ${N?"bg-black/50":"bg-white/10"}
                    `,children:(0,t.jsx)("button",{onClick:()=>$.push("anonlovemain"),className:"w-full h-full ",children:"<"})}),(0,t.jsx)("div",{className:`absolute right-0  flex justify-center items-center overflow-hidden
                    w-7 rounded-l-full bg-black/50 backdrop-blur-md hover:bg-white/20 transition-cursor
                    md:inset-y-0
                    inset-y-60
                    z-20
                    ${N?"bg-black/50":"bg-white/10"}
                    `,children:(0,t.jsx)("button",{onClick:()=>{A(!0)},className:"w-full h-full",children:"..."})}),(0,t.jsx)("div",{className:`fixed inset-0 z-20 bg-black/50 transition-all duration-300 overflow-hidden 
                            ${P?"backdrop-blur-lg translate-x-0":"backdrop-blur-none translate-x-full"}
                        `,onMouseDown:e=>A(!1),children:(0,t.jsx)("div",{className:"absolute right-0 inset-y-0 flex justify-center items-center    md:w-[400px] w-full bg-black/90 z-20",onMouseDown:e=>{e.stopPropagation()},children:(0,t.jsxs)("form",{className:"relative flex flex-col w-full justify-center items-center",onSubmit:e=>{e.preventDefault()},children:[(0,t.jsx)("input",{ref:R,value:b||"",onChange:e=>p(e.target.value),disabled:x,type:"text",placeholder:"ID кисы",className:`p-2 mb-4 w-1/2 bg-white/10 border rounded-md text-white
                                        ${x&&"opacity-50"}
                                `}),(0,t.jsxs)("div",{className:"flex w-full justify-center items-center",children:[(0,t.jsx)("input",{type:"checkbox",ref:I,checked:U,onChange:e=>{q(e.target.checked)},className:"bg-white/10 border rounded-md text-white"}),(0,t.jsx)("span",{className:"text-[10px]",children:`Будешь анонимен? (потом можно изменить)`})]}),(0,t.jsx)("button",{type:"submit",className:"p-2 mt-4 border rounded-2xl hover:bg-white/20 transition-all duration-200",onClick:J,children:"Отправить"}),(0,t.jsx)("button",{className:"absolute left-0 w-10 h-20 bg-white/20 rounded-r-full top-1/2 -translate-y-1/2   hover:bg-white/40 transition-all duration-200   ",onClick:()=>A(!1),children:">"})]})})})]}):S?.type==="recieve"?(0,t.jsxs)("div",{className:"relative flex flex-col justify-center items-center h-full overflow-hidden",style:{backgroundColor:G},children:[!z&&u&&(0,t.jsx)("div",{className:`relative border  rounded-md bg-white overflow-hidden z-10
                            ${N?"w-full h-1/2":"w-1/2 h-1/2"}
                            `,ref:T,onWheel:V,onTouchStart:ee,onTouchMove:et,onTouchEnd:es,style:{transform:`
                            translate(${L.offsetX}px, ${L.offsetY}px)
                            scale(${L.scale})
                            `,transformOrigin:"center center"},children:D.map((e,s)=>(0,t.jsx)("div",{className:`flex 
                                        text-black select-none relative 
                                        `,style:{position:"absolute",left:e.x,top:e.y,width:e.w,height:e.h,fontSize:e.fontSize,cursor:e.isSelected?"move":"pointer"},children:(0,t.jsx)("div",{className:`relative w-full h-full text-wrap wrap-break-word flex 
                                                ${e.isSelected?" ":"overflow-hidden"}`,children:e.content})},e.id))}),(0,t.jsx)("div",{className:`absolute left-0  flex justify-center items-center 
                    w-7 rounded-r-full backdrop-blur-md hover:bg-white/20 transition-cursor
                    md:inset-y-0
                    inset-y-60
                    z-20
                    ${N?"bg-black/50":"bg-white/10"}
                    `,children:(0,t.jsx)("button",{onClick:()=>$.push("anonlovemain"),className:"w-full h-full ",children:"<"})}),(0,t.jsx)("div",{className:`absolute right-0  flex justify-center items-center overflow-hidden
                    w-7 rounded-l-full bg-black/50 backdrop-blur-md hover:bg-white/20 transition-cursor
                    md:inset-y-0
                    inset-y-60
                    z-20
                    ${N?"bg-black/50":"bg-white/10"}
                    ${"true"===y?"hidden":""}
                    `,children:(0,t.jsx)("button",{onClick:()=>{A(!0)},className:"w-full h-full",children:"..."})}),(0,t.jsx)("div",{className:`fixed inset-0 z-20 bg-black/50 transition-all duration-300 overflow-hidden 
                            ${P?"backdrop-blur-lg translate-x-0":"backdrop-blur-none translate-x-full"}
                            ${"true"===y?"hidden":""}
                        `,onMouseDown:e=>A(!1),children:(0,t.jsx)("div",{className:"absolute right-0 inset-y-0 flex justify-center items-center    md:w-[400px] w-full bg-black/90 z-20",onMouseDown:e=>{e.stopPropagation()},children:(0,t.jsxs)("form",{className:"relative flex flex-col w-full justify-center items-center",onSubmit:e=>{e.preventDefault()},children:[(0,t.jsx)("input",{ref:R,value:m||"",onChange:e=>p(e.target.value),disabled:x,type:"text",placeholder:"ID кисы",className:`p-2 mb-4 w-1/2 bg-white/10 border rounded-md text-white
                                        ${x&&"opacity-50"}
                                `}),(0,t.jsxs)("div",{className:"flex w-full justify-center items-center",children:[(0,t.jsx)("input",{type:"checkbox",ref:I,checked:U,onChange:e=>{},className:"bg-white/10 border rounded-md text-white"}),(0,t.jsx)("span",{className:"text-[10px]",children:`Будешь анонимен? (потом можно изменить)`})]}),(0,t.jsx)("button",{type:"submit",className:"p-2 mt-4 border rounded-2xl hover:bg-white/20 transition-all duration-200",onClick:J,children:"Отправить"}),(0,t.jsx)("button",{className:"absolute left-0 w-10 h-20 bg-white/20 rounded-r-full top-1/2 -translate-y-1/2   hover:bg-white/40 transition-all duration-200   ",onClick:()=>A(!1),children:">"})]})})})]}):void 0}e.s(["default",()=>u],1356)}]);