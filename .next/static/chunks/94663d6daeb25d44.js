(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,82853,19184,79262,e=>{"use strict";var t=e.i(71645),s=e.i(14179);async function r(){let{data:e,error:t}=await s.supabase.auth.getUser();if(!t)return e.user}async function a(e){let{data:t,error:r}=await s.supabase.from("users").select("public_id, username").eq("id_user",e).single();return r?null:t}async function n(){let{error:e}=await s.supabase.auth.signOut();if(e)throw e}function l(e){let{data:t}=s.supabase.auth.onAuthStateChange((t,s)=>{e(s?.user||null)});return t.subscription}function i(){let[e,s]=(0,t.useState)(null),[n,i]=(0,t.useState)(null),[o,u]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{(async()=>{try{let e=await r();if(s(e),e){let t=await a(e.id);i(t)}}catch(e){console.error("Error loading user:",e)}finally{u(!1)}})();let e=l(async e=>{s(e),e?i(await a(e.id)):i(null)});return()=>{e.unsubscribe()}},[]),{user:e,profile:n,loading:o}}async function o(e){let{data:t,error:r}=await s.supabase.from("messages_safe").select(`
            *
            `).eq("to_user",e).order("created_at",{ascending:!0});if(r)throw r;return(t||[]).map(e=>{let t=e.user_anonymous_settings?.[0]?.is_anon;return{...e,displayId:t||e.is_anon?"Anon":e.from_public_id,username:t||e.is_anon?"Anon":e.from_username}})}async function u(e,t,r){console.log("Querying message:",{messageId:e,userId:t});let{data:a,error:n}=await s.supabase.from("messages_safe").select("*").eq("id",e).eq("true"===r?"from_user":"to_user",t).maybeSingle();if(console.log("Query result:",{data:a,error:n}),n)throw n;return a||[]}async function c(e){let{data:t,error:r}=await s.supabase.from("messages_safe").select(`
            *`).eq("from_user",e).order("created_at",{ascending:!0});if(r)throw r;return t||[]}async function d({fromUserId:e,toUserId:t,toPublicId:r,body:a,isAnon:n}){let l=t;if(!l){if(!r)throw Error("Не указан пользователь, малыш");let{data:e,error:t}=await s.supabase.from("users").select("id_user").eq("public_id",r).single();if(t||!e)throw Error("Пользователь не найден, кись");l=e.id_user}let{error:i}=await s.supabase.from("user_anonymous_settings").upsert([{from_user_id:e,to_user_id:l,is_anon:n}],{onConflict:"from_user_id,to_user_id"});if(i)throw i;let{error:o}=await s.supabase.from("messages").insert({from_user:e,to_user:l,body:a});if(o)throw o}function f(e){return{...e,isEditing:"none",isSelected:!1}}function h(e){let[s,r]=(0,t.useState)([]),[a,n]=(0,t.useState)([]),[l,i]=(0,t.useState)(!0),u=async()=>{if(e)try{i(!0);let[t,s]=await Promise.all([o(e),c(e)]);r(t),n(s)}catch(e){console.error("Error loading messages:",e)}finally{i(!1)}};return(0,t.useEffect)(()=>{u()},[e]),{inbox:s,sent:a,loading:l,sendMessage:async(t,s,r)=>{if(!e)throw Error("User not logged in");await d({fromUserId:e,toUserId:t.userId,toPublicId:t.publicId,body:s,isAnon:r}),await u()},refresh:u}}function m(e,s,r){let[a,n]=(0,t.useState)(null),[l,i]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{e&&s&&(async()=>{i(!0);try{let t=await u(s,e,r);n({...t,body:t.body.map(f)})}catch(e){console.error("Error loading messages:",e)}finally{i(!1)}})()},[e,s]),{message:a,loading:l}}function x(e,s,r){return(0,t.useMemo)(()=>{let t=new Map;for(let a of[...e,...s]){let e=a.from_user===r?a.to_user:a.from_user,s="";if(s="A"===a.from_display_id?"Anon":a.from_display_id,t.has(e)){let s=t.get(e);s.messages.push(a),s.count++,new Date(a.created_at)>new Date(s.lastMessage.created_at)&&(s.lastMessage=a)}else t.set(e,{userId:e,displayId:s,lastMessage:a,messages:[a],count:1})}return Array.from(t.values()).sort((e,t)=>new Date(t.lastMessage.created_at).getTime()-new Date(e.lastMessage.created_at).getTime())},[e,s,r])}e.s(["getCurrentUser",()=>r,"getUserProfile",()=>a,"onAuthStateChange",()=>l,"sighOut",()=>n],19184),e.s(["useAuth",()=>i],82853),e.s(["useCurrentMessage",()=>m,"useDialogs",()=>x,"useMessages",()=>h],79262)},33005,e=>{"use strict";var t=e.i(71645);function s(e=768){let[r,a]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{let e=()=>{a(window.innerWidth<=768)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[e]),r}e.s(["useCheckMobile",()=>s])},3411,e=>{"use strict";var t=e.i(43476),s=e.i(71645),r=e.i(18566),a=e.i(82853),n=e.i(79262),l=e.i(19184);function i({onSwipeLeft:e,onSwipeRight:t,threshold:r=50}){let a=(0,s.useRef)(null);return{onTouchStart:e=>{a.current=e.touches[0].clientX},onTouchEnd:s=>{if(null===a.current)return;let n=s.changedTouches[0].clientX-a.current;Math.abs(n)>r&&(n>0?t?.():e?.()),a.current=null}}}var o=e.i(33005);function u(){let e=(0,r.useRouter)(),{user:u,profile:d,loading:f}=(0,a.useAuth)(),{inbox:h,sent:m,sendMessage:x,loading:g}=(0,n.useMessages)(u?.id||null),w=(0,n.useDialogs)(h,m,u?.id||""),[p,b]=(0,s.useState)(null),y=w.find(e=>e.userId===p),[v,_]=(0,s.useState)(!1),j=(0,o.useCheckMobile)(),[C,N]=(0,s.useState)(!1),M=(0,s.useRef)(null);(0,s.useRef)(null);let[k,S]=(0,s.useState)(!1),[E,R]=(0,s.useState)(null),[A,I]=(0,s.useState)(!1),[U,$]=(0,s.useState)(!1),L=i({onSwipeRight:()=>{j&&_(!1)}}),P=i({onSwipeLeft:()=>{j&&$(!1)},onSwipeRight:()=>{j&&$(!0)}});(0,s.useEffect)(()=>{C&&M.current&&(M.current.value=E?.id||"")},[C,E]),(0,s.useEffect)(()=>{!f&&(u||e.replace("/anonlove/auth"))},[u,f,e]),(0,s.useEffect)(()=>{j||_(!1)},[j]);let T=async()=>{await (0,l.sighOut)(),e.push("/anonlove/auth")};return f?(0,t.jsx)("div",{className:"bg-black min-h-screen flex items-center justify-center text-white",children:"Загрузка..."}):(0,t.jsxs)("div",{className:"relative bg-black min-h-screen flex flex-col overflow-hidden",children:[(0,t.jsxs)("main",{className:"relative flex-1 text-white flex md:flex-row flex-col overflow-hidden",...!v?P:{},onClick:()=>{U&&$(!1)},children:[(0,t.jsxs)("div",{className:`absolute inset-0 bg-[#12080b] 
                            overflow-y-auto
                            transition-transform duration-300 ease-out will-change-transform
                            md:static md:translate-x-0 md:w-1/2
                            ${j&&v?"-translate-x-full":"translate-x-0"}
                        `,children:[(0,t.jsxs)("div",{className:"flex w-full relative bg-white/10 backdrop-blur-md",children:[(0,t.jsx)("div",{className:"absolute left-2 top-1/2 -translate-y-1/2 rounded-full bg-white/10 h-8 w-15 flex justify-center items-center",children:(0,t.jsx)("button",{onClick:()=>{$(!0)},className:"bg-white/20 w-8 h-8 rounded-full",children:d?.public_id.charAt(1).toUpperCase()})}),(0,t.jsxs)("button",{className:" p-2 rounded-md w-full text-center flex justify-center items-center gap-1",children:[(0,t.jsx)("span",{className:"medium",children:"Чаты"}),(0,t.jsx)("span",{className:`w-3 h-3 rounded-full border transition bg-white border-white
                                `})]}),(0,t.jsx)("div",{className:"absolute bottom-1/2 translate-y-1/2 right-2",children:(0,t.jsx)(c,{openModal:()=>{e.push("createcard?type=send")},children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 32 32",children:(0,t.jsx)("path",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M2 4h28v18H16l-8 7v-7H2Z"})})})})]}),w.map(e=>{let s=e.displayId.charAt(1).toUpperCase(),r=e.displayId;return(0,t.jsx)("button",{className:"border border-[#8f18504e] p-2 rounded-lg w-full",onClick:()=>{b(e.userId),_(!0)},children:(0,t.jsxs)("div",{className:"flex p-2 items-center gap-2 relative",children:[(0,t.jsx)("span",{className:"flex bg-red-500 w-8 h-8 items-center justify-center rounded-full text-lg font-bold",children:s}),(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("span",{className:"font-semibold",children:r}),(0,t.jsx)("span",{className:"text-[10px] text-gray-400 absolute bottom-0 right-1 ",children:e.lastMessage.created_at.slice(11,16)})]})]})},e.userId)})]}),(0,t.jsxs)("div",{...j?L:{},className:`
                        absolute inset-0 bg-[#12080b] 
                        overflow-y-auto
                        transition-transform duration-300 ease-in-out will-change-transform
                        md:static md:translate-x-0 md:w-1/2
                        ${v?"translate-x-0":"translate-x-full"}
                    `,children:[j&&(0,t.jsx)("button",{className:" bg-white/10 backdrop-blur-2xl m-2 w-15 h-8 text-center rounded-full z-10",onClick:()=>_(!1),children:"←"}),y?.messages.map(s=>{let r=s.from_display_id.charAt(1).toUpperCase(),a=s.from_display_id,n=s.from_user===u?.id;return"Anon"===s.from_display_id?s.from_user:s.from_display_id,(0,t.jsxs)("div",{className:`flex flex-col relative w-full transition hover:bg-white/10
                                    ${n?"items-end":"items-start"}
                                `,children:[(0,t.jsxs)("div",{className:`flex items-center gap-2 p-2 cursor-pointer max-w-[80%]
                                        ${n?"flex-row-reverse text-right":"flex-row"}
                                    `,onClick:()=>{e.push(`createcard?isMine=${n}&id=${encodeURIComponent(s.id)}&type=recieve&to=${encodeURIComponent(s?.from_display_id??"")}`)},children:[(0,t.jsx)("div",{className:"md:w-10 md:h-10 w-8 h-8   rounded-full bg-red-500   flex items-center justify-center   text-lg font-bold shrink-0",children:r}),(0,t.jsxs)("div",{className:"flex flex-col",children:[(0,t.jsx)("span",{className:"font-semibold medium",children:a}),(0,t.jsx)("span",{className:"small line-clamp-2",children:""})]})]}),!n&&(0,t.jsx)("button",{className:"absolute top-1/2 right-1 -translate-y-1/2",onClick:()=>{e.push(`createcard?isMine=${n}&type=send&to=${encodeURIComponent(s?.from_display_id??"")}`)},children:(0,t.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"18",height:"18",viewBox:"0 0 14 14",children:(0,t.jsxs)("g",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,t.jsx)("path",{d:"M7.5.5h-5a1 1 0 0 0-1 1v9l-1 3l4-1h8a1 1 0 0 0 1-1v-5"}),(0,t.jsx)("path",{d:"m8.363 8.137l-3 .54l.5-3.04l4.73-4.71a.999.999 0 0 1 1.42 0l1.06 1.06a1.001 1.001 0 0 1 0 1.42z"})]})})}),(0,t.jsx)("div",{className:"w-full mx-auto bg-white/20 h-px"})]},s.id)})]})]}),(0,t.jsxs)("div",{...j?P:{},className:`flex flex-1 flex-col items-center absolute bg-black/50 backdrop-blur-md transition-transform duration-150 ease-in-out will-change-transform
                    ${U?"translate-x-0":"-translate-x-full "}
                    ${j?"inset-0":"w-1/3 h-full"}
                    `,onClick:e=>{e.stopPropagation()},children:[(0,t.jsx)("div",{className:"bg-white/20 backdrop-blur-2xl w-full flexC p-2 rounded-b-2xl",children:d?.public_id}),(0,t.jsx)("div",{className:"absolute bottom-0 bg-white/10 p-2 backdrop-blur-md w-full flexC rounded-t-2xl",children:(0,t.jsx)("button",{className:"text-red-500",onClick:()=>{T()},children:"Выйти"})}),(0,t.jsx)("button",{className:"absolute h-40 top-1/2 -translate-y-1/2 right-0 bg-white/20 backdrop-blur-2xl flexC p-1    animate-pulse rounded-l-2xl   ",onClick:()=>$(!1),children:">"})]})]})}function c({children:e,openModal:r}){let a=(0,s.useRef)(null),n=(0,s.useRef)(null),l=(0,s.useRef)(0),i=(0,s.useRef)(!1),o=(0,s.useRef)({w:0,h:0});return(0,s.useEffect)(()=>{let e=a.current,t=n.current;if(!e||!t)return;let s=e.getContext("2d");if(!s)return;let r=()=>{let t=e.parentElement.getBoundingClientRect(),r=window.devicePixelRatio||1;o.current.w=t.width,o.current.h=t.height,e.width=t.width*r,e.height=t.height*r,e.style.width=t.width+"px",e.style.height=t.height+"px",s.setTransform(r,0,0,r,0,0)};r();let u=[],c=performance.now();return l.current=requestAnimationFrame(function r(a){let n;if(!s||!e)return;let d=(a-c)/1e3;c=a;let{w:f,h}=o.current;if(s.clearRect(0,0,f,h),.06>Math.random()){let e=Math.random()*Math.PI*2;u.push({x:Math.random()*f,y:Math.random()*h,radius:1,alpha:1,life:1,vx:50*Math.cos(e),vy:50*Math.sin(e)})}let m=(t.getBoundingClientRect(),{x:(n=e.getBoundingClientRect()).width/2,y:n.height/2});for(let e=u.length-1;e>=0;e--){let t=u[e];if(t.life-=.3*d,t.alpha=t.life,i.current){let e=m.x-t.x,s=m.y-t.y,r=Math.sqrt(e*e+s*s)+.001,a=400*Math.max(0,1-r/700);t.vx+=e/r*a*d,t.vy+=s/r*a*d}let r=Math.hypot(t.vx,t.vy);if(r>160&&(t.vx=t.vx/r*160,t.vy=t.vy/r*160),t.x+=t.vx*d,t.y+=t.vy*d,t.alpha<=0){u.splice(e,1);continue}s.globalAlpha=t.alpha,s.shadowBlur=1,s.shadowColor="white",s.fillStyle="white",s.beginPath(),s.arc(t.x,t.y,t.radius,0,2*Math.PI),s.fill()}s.globalAlpha=1,l.current=requestAnimationFrame(r)}),window.addEventListener("resize",r),()=>{l.current&&cancelAnimationFrame(l.current),window.removeEventListener("resize",r)}},[]),(0,t.jsxs)("div",{className:"relative flex justify-center items-center h-full w-full",children:[(0,t.jsx)("canvas",{ref:a,className:"absolute w-full h-full pointer-events-none z-1"}),(0,t.jsx)("button",{ref:n,onClick:()=>r(),onMouseEnter:()=>i.current=!0,onMouseLeave:()=>i.current=!1,className:"relative flex items-center justify-center p-2 h-8 w-15 bg-white/10 rounded-full hover:bg-white/40 transition-colors z-2",children:e})]})}e.s(["default",()=>u,"dynamic",0,"force-dynamic"],3411)}]);