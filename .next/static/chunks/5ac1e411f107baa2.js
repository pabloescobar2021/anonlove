(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,79262,e=>{"use strict";var t=e.i(71645),s=e.i(14179);async function r(e){let{data:t,error:r}=await s.supabase.from("messages_safe").select(`
            *
            `).eq("to_user",e).order("created_at",{ascending:!0});if(r)throw r;return(t||[]).map(e=>{let t=e.user_anonymous_settings?.[0]?.is_anon;return{...e,displayId:t||e.is_anon?"Anon":e.from_public_id,username:t||e.is_anon?"Anon":e.from_username}})}async function n(e,t){let{data:r,error:n}=await s.supabase.from("messages_safe").select("*").eq("id",e).eq("to_user",t).single();if(n)throw n;return r||[]}async function a(e){let{data:t,error:r}=await s.supabase.from("messages_safe").select(`
            *`).eq("from_user",e).order("created_at",{ascending:!0});if(r)throw r;return t||[]}async function i({fromUserId:e,toUserId:t,toPublicId:r,body:n,isAnon:a}){let i=t;if(!i){if(!r)throw Error("Не указан пользователь, малыш");let{data:e,error:t}=await s.supabase.from("users").select("id_user").eq("public_id",r).single();if(t||!e)throw Error("Пользователь не найден, кись");i=e.id_user}let{error:o}=await s.supabase.from("user_anonymous_settings").upsert([{from_user_id:e,to_user_id:i,is_anon:a}],{onConflict:"from_user_id,to_user_id"});if(o)throw o;let{error:l}=await s.supabase.from("messages").insert({from_user:e,to_user:i,body:n});if(l)throw l}function o(e){let[s,n]=(0,t.useState)([]),[o,l]=(0,t.useState)([]),[u,c]=(0,t.useState)(!0),d=async()=>{if(e)try{c(!0);let[t,s]=await Promise.all([r(e),a(e)]);n(t),l(s)}catch(e){console.error("Error loading messages:",e)}finally{c(!1)}};return(0,t.useEffect)(()=>{d()},[e]),{inbox:s,sent:o,loading:u,sendMessage:async(t,s,r)=>{if(!e)throw Error("User not logged in");await i({fromUserId:e,toUserId:t.userId,toPublicId:t.publicId,body:s,isAnon:r}),await d()},refresh:d}}function l(e,s){let[r,a]=(0,t.useState)(null),[i,o]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{e&&s&&(async()=>{o(!0);try{let t=await n(s,e);a(t)}catch(e){console.error("Error loading messages:",e)}finally{o(!1)}})()},[e,s]),{message:r,loading:i}}function u(e,s,r){return(0,t.useMemo)(()=>{let t=new Map;for(let n of[...e,...s]){let e=n.from_user===r?n.to_user:n.from_user,s="";if(s="A"===n.from_display_id?"Anon":n.from_display_id,t.has(e)){let s=t.get(e);s.messages.push(n),s.count++,new Date(n.created_at)>new Date(s.lastMessage.created_at)&&(s.lastMessage=n)}else t.set(e,{userId:e,displayId:s,lastMessage:n,messages:[n],count:1})}return Array.from(t.values()).sort((e,t)=>new Date(t.lastMessage.created_at).getTime()-new Date(e.lastMessage.created_at).getTime())},[e,s,r])}e.s(["useCurrentMessage",()=>l,"useDialogs",()=>u,"useMessages",()=>o],79262)},82853,19184,e=>{"use strict";var t=e.i(71645),s=e.i(14179);async function r(){let{data:e,error:t}=await s.supabase.auth.getUser();if(!t)return e.user}async function n(e){let{data:t,error:r}=await s.supabase.from("users").select("public_id, username").eq("id_user",e).single();return r?null:t}async function a(){let{error:e}=await s.supabase.auth.signOut();if(e)throw e}function i(e){let{data:t}=s.supabase.auth.onAuthStateChange((t,s)=>{e(s?.user||null)});return t.subscription}function o(){let[e,s]=(0,t.useState)(null),[a,o]=(0,t.useState)(null),[l,u]=(0,t.useState)(!0);return(0,t.useEffect)(()=>{(async()=>{try{let e=await r();if(s(e),e){let t=await n(e.id);o(t)}}catch(e){console.error("Error loading user:",e)}finally{u(!1)}})();let e=i(async e=>{s(e),e?o(await n(e.id)):o(null)});return()=>{e.unsubscribe()}},[]),{user:e,profile:a,loading:l}}e.s(["getCurrentUser",()=>r,"getUserProfile",()=>n,"onAuthStateChange",()=>i,"sighOut",()=>a],19184),e.s(["useAuth",()=>o],82853)},1356,e=>{"use strict";var t=e.i(43476),s=e.i(71645),r=e.i(18566);let n=(e,t,s)=>e+(t-e)*s,a=()=>({r:Math.floor(256*Math.random()),g:0,b:0,a:.1});var i=e.i(79262),o=e.i(82853);function l({initialData:e}){let l,u,c,d,f,h,m=(0,r.useSearchParams)().get("to"),g=m?decodeURIComponent(m):null,[w,b]=(0,s.useState)(null),[p,x]=(0,s.useState)(!1),{user:v,profile:y,loading:_}=(0,o.useAuth)(),{inbox:j,sent:M,sendMessage:S,loading:N}=(0,i.useMessages)(v?.id||null),E=(0,r.useRouter)(),[k,C]=(0,s.useState)(e?.items||[]),z=(0,s.useRef)(null),[D,A]=(0,s.useState)(!1),P=(0,s.useRef)(null),R=(0,s.useRef)(null),[I,Y]=(0,s.useState)(!1),[L,X]=(0,s.useState)(!1),{startDrag:$,startResize:T,deleteItem:U}=(l=(0,s.useRef)({id:null,offsetX:0,offsetY:0,w:0,h:0}),u=(0,s.useRef)({id:null,startX:0,startY:0,startW:0,startH:0,fontSize:0,direction:"horizontal"}),c=e=>{if(null!==u.current.id)return;let t=z.current.getBoundingClientRect(),s=l.current;if(null===s.id)return;let r=e.clientX-t.left-s.offsetX,n=e.clientY-t.top-s.offsetY;r=Math.max(-s.w/2,Math.min(r,t.width-s.w/2)),n=Math.max(-s.h/2,Math.min(n,t.height-s.h/2)),C(e=>e.map(e=>e.id===s.id?{...e,x:r,y:n}:e))},d=()=>{l.current.id=null,window.removeEventListener("mousemove",c),window.removeEventListener("mouseup",d)},f=e=>{let t=u.current;if(null===t.id)return;let s=e.clientX-t.startX,r=e.clientY-t.startY,n=t.startW,a=t.startH,i=t.fontSize;"horizontal"===t.direction&&(n=Math.max(50,t.startW+s)),"top"===t.direction&&(a=Math.max(30,t.startH+r)),"bottom"===t.direction&&(a=Math.max(30,t.startH+r)),"diagonal"===t.direction&&(n=Math.max(50,t.startW+s),a=Math.max(30,t.startH+r),i=Math.max(2,t.fontSize+(s+r)/5)),console.log("resize direction:",t.direction,"w:",n,"h:",a,"fontSize:",i),C(e=>e.map(e=>e.id===t.id?{...e,w:n,h:a,fontSize:i}:e))},h=()=>{u.current.id=null,window.removeEventListener("mousemove",f),window.removeEventListener("mouseup",h)},{startDrag:(e,t)=>{let s=z.current.getBoundingClientRect();l.current={id:t.id,offsetX:e.clientX-s.left-t.x,offsetY:e.clientY-s.top-t.y,w:t.w,h:t.h},window.addEventListener("mousemove",c),window.addEventListener("mouseup",d)},startResize:(e,t,s)=>{e.stopPropagation(),u.current={id:t.id,startX:e.clientX,startY:e.clientY,startW:t.w,startH:t.h,fontSize:t.fontSize,direction:s},window.addEventListener("mousemove",f),window.addEventListener("mouseup",h)},deleteItem:e=>{C(t=>t.filter(t=>t.id!==e.id))}});(0,s.useEffect)(()=>{g&&(b(g),x(!0))},[g]);let{bg:q}=function(){let[e,t]=(0,s.useState)({r:0,g:0,b:0,a:.1}),r=(0,s.useRef)(e),i=(0,s.useRef)(null);return(0,s.useEffect)(()=>{let e=null,s=r.current,o=a(),l=u=>{var c,d;let f;e||(e=u);let h=Math.min((u-e)/3e3,1),m=(c=s,d=o,f=h*h*(3-2*h),{r:n(c.r,d.r,f),g:n(c.g,d.g,f),b:n(c.b,d.b,f),a:n(c.a,d.a,f)});r.current=m,t(m),h<1||(s=o,o=a(),e=null),i.current=requestAnimationFrame(l)};return i.current=requestAnimationFrame(l),()=>{i.current&&cancelAnimationFrame(i.current)}},[]),{bg:e}}(),B=`rgba(${Math.floor(q.r)}, ${Math.floor(q.g)}, ${Math.floor(q.b)}, ${q.a})`,H=async()=>{let e=P.current?.value||"";if(R.current?.checked,!e)return void alert("Введи ID, сладкий!");let t=k.map(({isSelected:e,isEditing:t,...s})=>s);console.log("SEND PAYLOAD",t);try{await S({publicId:e},t,I),P.current.value="",A(!1)}catch(e){console.log(e.message||"Error sending message")}};return(0,t.jsxs)("div",{className:"relative flex flex-col justify-center items-center h-full",style:{backgroundColor:B},children:[(0,t.jsx)("div",{className:"relative border w-1/2 h-1/2 rounded-md bg-white overflow-hidden z-10 ",ref:z,onMouseDown:e=>{e.target===e.currentTarget&&C(e=>e.map(e=>({...e,isSelected:!1,isEditing:"none"})))},children:k.map((e,s)=>(0,t.jsx)("div",{className:`flex 
                                text-black select-none relative 
                                ${e.isSelected&&"text"!==e.isEditing?"border":""}
                                `,style:{position:"absolute",left:e.x,top:e.y,width:e.w,height:e.h,fontSize:e.fontSize,cursor:e.isSelected?"move":"pointer"},onDoubleClick:()=>{C(t=>t.map(t=>t.id===e.id?{...t,isEditing:"text"}:t))},onMouseDown:t=>{$(t,e),C(t=>t.map(t=>({...t,isSelected:t.id===e.id})))},children:"text"===e.isEditing?(0,t.jsx)("input",{autoFocus:!0,value:e.content,onChange:t=>{C(s=>s.map(s=>s.id===e.id?{...s,content:t.target.value}:s))},onBlur:()=>{C(t=>t.map(t=>t.id===e.id?{...t,isEditing:"none"}:t))},onKeyDown:e=>{"Enter"===e.key&&e.currentTarget.blur()}}):(0,t.jsxs)("div",{className:`relative w-full h-full text-wrap wrap-break-word flex 
                                            ${e.isSelected?" ":"overflow-hidden"}`,children:[e.content,e.isSelected&&(0,t.jsxs)("div",{className:"",children:[(0,t.jsx)("div",{className:"absolute -top-1.5 -right-2.5 ",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("svg",{onClick:e=>{L?X(!1):X(!0),e.stopPropagation()},className:"hover:scale-110 transition-transform cursor-pointer",xmlns:"http://www.w3.org/2000/svg",width:"10",height:"10",viewBox:"0 0 32 32",children:(0,t.jsx)("path",{fill:"none",stroke:"currentColor",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M4 8h24M4 16h24M4 24h24"})}),(0,t.jsx)("div",{className:`absolute top-1 left-full text-[9px] bg-black/20 rounded-md w-15 h-15 flex flex-col
                                                        ${L?"opacity-100":"opacity-0"} transition-opacity`,children:(0,t.jsx)("button",{className:"hover:bg-black/10 transition-colors",onClick:()=>{U(e)},children:"Удалить"})})]})}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),T(t,e,"horizontal")},className:"absolute -right-1 bottom-1/2 translate-y-1/2 w-1 h-3 bg-white    border cursor-w-resize"}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),T(t,e,"top")},className:"absolute -top-1 left-1/2 -translate-x-1/2 w-3 h-1 bg-white    border cursor-s-resize"}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),T(t,e,"bottom")},className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-3 h-1 bg-white    border cursor-s-resize"}),(0,t.jsx)("div",{onMouseDown:t=>{t.stopPropagation(),T(t,e,"diagonal")},className:"absolute -bottom-1.5 -right-1.5  w-2 h-2 bg-white    border cursor-se-resize"})]})]})},e.id))}),(0,t.jsx)("div",{className:"flex p-2 mt-10",children:(0,t.jsx)("button",{className:"p-2 border rounded-2xl",onClick:()=>{C(e=>[...e,{id:e.length,type:"text",content:`new text ${e.length+1}`,x:0,y:0+20*e.length,w:100,h:50,fontSize:16,scaleX:1,scaleY:1,rotation:0,isEditing:"none"}])},children:"Text"})}),(0,t.jsx)("div",{className:"absolute left-0 inset-y-0 flex justify-center items-center    w-7 rounded-r-full bg-white/10 hover:bg-white/20 transition-cursor",children:(0,t.jsx)("button",{onClick:()=>E.push("anonlovemain"),className:"w-full h-full",children:"<"})}),(0,t.jsxs)("div",{className:"absolute right-0 inset-y-0 flex justify-center items-center   w-7 rounded-l-full bg-white/10 hover:bg-white/20 transition-cursor",children:[(0,t.jsx)("button",{onClick:()=>{A(!0)},className:"w-full h-full",children:"..."}),(0,t.jsx)("div",{className:`fixed inset-0 z-30 bg-black/50 transition-all duration-300
                                ${D?"backdrop-blur-lg translate-x-0":"backdrop-blur-none translate-x-full"}
                            `,onMouseDown:e=>A(!1),children:(0,t.jsx)("div",{className:"absolute right-0 inset-y-0 flex justify-center items-center w-[400px] bg-black/90 z-20",onMouseDown:e=>{e.stopPropagation()},children:(0,t.jsxs)("form",{className:"relative flex flex-col w-full justify-center items-center",onSubmit:e=>{e.preventDefault()},children:[(0,t.jsx)("input",{ref:P,value:w||"",onChange:e=>b(e.target.value),disabled:p,type:"text",placeholder:"ID кисы",className:`p-2 mb-4 w-1/2 bg-white/10 border rounded-md text-white
                                            ${p&&"opacity-50"}
                                    `}),(0,t.jsxs)("div",{className:"flex w-full justify-center items-center",children:[(0,t.jsx)("input",{type:"checkbox",ref:R,checked:I,onChange:e=>{},className:"bg-white/10 border rounded-md text-white"}),(0,t.jsx)("span",{className:"text-[10px]",children:`Будешь анонимен? (потом можно изменить)`})]}),(0,t.jsx)("button",{type:"submit",className:"p-2 mt-4 border rounded-2xl hover:bg-white/20 transition-all duration-200",onClick:H,children:"Отправить"}),(0,t.jsx)("button",{className:"absolute left-0 w-10 h-20 bg-white/20 rounded-r-full top-1/2 -translate-y-1/2   hover:bg-white/40 transition-all duration-200   ",onClick:()=>A(!1),children:">"})]})})})]})]})}e.s(["default",()=>l],1356)}]);